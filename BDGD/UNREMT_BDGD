(
SELECT
CAST (GEN.COD_ID as VARCHAR(20)) as COD_ID,
GEN.DIST,
GEN.FAS_CON,
GEN.SIT_ATIV,
GEN.TIP_UNID,
CASE 
WHEN GEN.PAC1 IS NULL THEN '0'
ELSE CAST (GEN.PAC1  as VARCHAR(20))END  as PAC_1,
CASE 
WHEN GEN.PAC2 IS NULL THEN '0'
ELSE CAST (GEN.PAC2  as VARCHAR(20))END  as PAC_2,
DECODE(NV.UN_TR_S, NULL, 'SE-'||BAR.ID_TT, NV.UN_TR_S) as UNI_TR_S,
DECODE(NV.NOVO_ALIMENTADOR, NULL, GEN.CTMT, NV.NOVO_ALIMENTADOR) AS "CTMT",
CAST (GEN.SUB as VARCHAR(20)) as SUB,
GEN.CONJ,
GEN.MUN,
TO_CHAR(TO_DATE(SAP.DAT_CON, 'DD/MM/RR'), 'DD/MM/YYYY') AS DAT_CON,
GEN.BANC,
'PD' as POS,
GEN.DESCR,
GEN.GEOMETRY
FROM BDGD_STAGING.MV_GENESIS_UNREMT GEN 
INNER JOIN 
(
SELECT LOCAL_INSTALACAO, 
MAX (
CASE 
  WHEN SAP.DATA_CONEXAO='00/00/0000' THEN TO_DATE('01/01/0001','YYYY-MM-DD') 
  ELSE TO_DATE(SAP.DATA_CONEXAO,'DD/MM/YYYY')END 
  )as  DAT_CON
FROM MV_BDGD_SAP SAP
WHERE
   OBJ_TECNICO in ('RG', 'TRT') AND  
   LOCAL_INSTALACAO is not null AND
   SAP.A2<=34
GROUP BY LOCAL_INSTALACAO
) SAP ON SAP.LOCAL_INSTALACAO = GEN.DESCR
INNER JOIN
( SELECT * FROM BDGD_STAGING.MV_GENESIS_UNREMT)  GEN ON  GEN.DESCR = SAP.LOCAL_INSTALACAO
LEFT JOIN BDGD_STAGING.TAB_ALI_BAR_TT BAR ON BAR.CD_ALIMENTADOR=GEN.CD_ALIMENTADOR
LEFT JOIN BDGD_STAGING.TAB_BDGD_NOVOS_ALIMS NV
ON NV.ALIMENTADOR = GEN.CD_ALIMENTADOR

)

UNION ALL

(
SELECT 
SUBST.COD_ID,
SUBST.DIST,
SUBST.FAS_CON,
SUBST.SIT_ATIV,
SUBST.TIP_UNID,
SUBST.PAC_1,
SUBST.PAC_2,
SUBST.UNI_TR_S,
SUBST.CTMT,
SUBST.SUB,
SUBST.CONJ,
SUBST.MUN,
SUBST.DAT_CON,
SUBST.BANC,
SUBST.POS,
SUBST.DESCR,
GEO.GEOMETRY
FROM
(
SELECT
DISTINCT
'SE-'||NS.OBJECTID as COD_ID,
5697 as DIST,
'ABC'  as FAS_CON,
'AT'  as SIT_ATIV,
14 as TIP_UNID,
CASE 
WHEN SUB.PAC1_FID is null THEN '0'
ELSE 'SE-'||SUB.PAC1_FID END as PAC_1,
CASE 
WHEN SUB.PAC2_FID is null THEN '0'
ELSE 'SE-'||SUB.PAC2_FID END as PAC_2,
DECODE(NODE2.OBJECTID,NULL, '0', 'SE-' || NODE2.OBJECTID) AS UNI_TR_S, 
DECODE(NV.NOVO_ALIMENTADOR, NULL, BAR.CD_ALIMENTADOR, NV.NOVO_ALIMENTADOR) AS "CTMT",
GEN.SUB,
GEN.CONJ,
GEN.MUNICIPIO as MUN,
TO_CHAR(TO_DATE(DT_CNX.DAT_CON, 'DD/MM/RR'), 'DD/MM/YYYY') AS DAT_CON,
1 as BANC,
'PD' as POS,
SAP.LOCAL_INSTALACAO as DESCR,
SUB.PAC2
FROM
MV_BDGD_SAP SAP 
INNER JOIN BDGD_STAGING.TAB_BDGD_SUB_CONN SUB         ON SAP.LOCAL_INSTALACAO=SUB.PAC2
INNER JOIN BDGD_STAGING.TAB_NODE_SUB NS          ON NS.LOC_INST_SAP=SUB.PAC2
INNER JOIN BDGD_STAGING.MV_GENESIS_EQPTO_SUB GEN ON  'SE-'||GEN.NR_SUB = SAP.SUBESTACAO
LEFT JOIN BDGD_STAGING.TAB_ALI_BAR_TT  BAR ON BAR.LOC_INST_SAP_ALI = NS.ALIMENTADOR
LEFT JOIN BDGD_STAGING.TAB_NODE_SUB NODE2 ON NODE2.LOC_INST_SAP = NS.UN_TR_S
LEFT JOIN BDGD_STAGING.TAB_BDGD_NOVOS_ALIMS NV ON NV.ALIMENTADOR = BAR.CD_ALIMENTADOR
LEFT JOIN
(
 SELECT LOCAL_INSTALACAO, 
    MAX (
    CASE 
    WHEN SAP.DATA_CONEXAO='00/00/0000' THEN TO_DATE('01/01/0001','YYYY-MM-DD') 
    ELSE TO_DATE(SAP.DATA_CONEXAO,'DD/MM/YYYY')END 
  )as  DAT_CON
  FROM MV_BDGD_SAP SAP
  WHERE
   OBJ_TECNICO in ('RG', 'TRT') AND  
   LOCAL_INSTALACAO is not null AND
   SAP.A2<=34
  GROUP BY LOCAL_INSTALACAO
)  DT_CNX ON DT_CNX.LOCAL_INSTALACAO=SAP.LOCAL_INSTALACAO
WHERE
OBJ_TECNICO in ('RG','TRT') AND
SAP.A2<60
) SUBST
INNER JOIN  
(SELECT NS.LOC_INST_SAP,NS.SHAPE as GEOMETRY FROM BDGD_STAGING.TAB_NODE_SUB NS ) GEO ON GEO.LOC_INST_SAP=SUBST.PAC2
)