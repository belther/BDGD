(
SELECT 
CAST (GEN.COD_ID as VARCHAR(20)) as COD_ID,
GEN.DIST,
GEN.FAS_CON,
GEN.SIT_ATIV,
GEN.TIP_UNID,
CAST(SAP.POT_NOM as VARCHAR(3))as POT_NOM,
CAST(GEN.PAC_1 as VARCHAR(20)) as PAC_1,
CAST(GEN.PAC_2 as VARCHAR(20)) as PAC_2,
DECODE(NV.NOVO_ALIMENTADOR, NULL, GEN.CD_ALIMENTADOR, NV.NOVO_ALIMENTADOR,'0') AS "CTMT",
DECODE(NV.UN_TR_S, NULL, 'SE-'||BAR.ID_TT, NV.UN_TR_S) as UNI_TR_S,
COALESCE(GEN.SUB,'0') as SUB,
GEN.CONJ,
GEN.MUN,
GEN.ARE_LOC,
LOCINS.DAT_CON,
GEN.BANC,
GEN.POS,
GEN.DESCR,
GEN.GEOMETRY
FROM
(
SELECT
LOCAL_INSTALACAO,
MAX(POT.COD_ID) as POT_NOM
FROM MV_BDGD_SAP SAP
LEFT JOIN TPOTRTV POT ON POT.POT=SAP.A4_TEC
   WHERE SAP.bdgd = 'EQCR' AND 
   SAP.LOCAL_INSTALACAO is not null AND
   LOCAL_INSTALACAO not like 'AX-%'
GROUP BY LOCAL_INSTALACAO
)   SAP
INNER JOIN 
(
SELECT LOCAL_INSTALACAO, 
MAX (
CASE 
  WHEN SAP.DATA_CONEXAO='00/00/0000' THEN '01/01/0001' 
  ELSE SAP.DATA_CONEXAO END 
  )as  DAT_CON
FROM MV_BDGD_SAP SAP
   WHERE SAP.bdgd = 'EQCR' AND 
   SAP.LOCAL_INSTALACAO is not null AND
   LOCAL_INSTALACAO NOT LIKE 'AX-%'
GROUP BY LOCAL_INSTALACAO
) LOCINS ON LOCINS.LOCAL_INSTALACAO = SAP.LOCAL_INSTALACAO
INNER JOIN
(SELECT * FROM BDGD_STAGING.MV_GENESIS_UNCRMT)  GEN   ON  GEN.DESCR          = SAP.LOCAL_INSTALACAO
 LEFT JOIN BDGD_STAGING.TAB_ALI_BAR_TT                   BAR   ON  BAR.CD_ALIMENTADOR = GEN.CD_ALIMENTADOR
 LEFT JOIN BDGD_STAGING.TAB_BDGD_NOVOS_ALIMS             NV    ON  NV.ALIMENTADOR     = GEN.CD_ALIMENTADOR
)
UNION ALL
--SUBESTAÇÃO
(
SELECT
'SE-'||NS.OBJECTID as COD_ID,
5697 as DIST,
'ABC'  as FAS_CON,
'AT'  as SIT_ATIV,
14 as TIP_UNID,
POT.COD_ID as POT_NOM,
'SE-'||SUB.PAC1_FID as PAC_1,
'SE-'||SUB.PAC2_FID as PAC_2,
'0' as CTMT,
DECODE(NODE2.OBJECTID,NULL, '0', 'SE-' || NODE2.OBJECTID) AS UNI_TR_S, 
COALESCE(GEN.SUB,'0') as SUB,
GEN.CONJ,
GEN.MUNICIPIO as MUN,
TARE.COD_ID as ARE_LOC,
CASE 
  WHEN SAP.DATA_CONEXAO='00/00/0000' THEN '01/01/0001' 
  ELSE SAP.DATA_CONEXAO END as  DAT_CON,
0 as BANC,
'PD' as POS,
SAP.LOCAL_INSTALACAO as DESCR,
NS.SHAPE as GEOMETRY
FROM
(SELECT * FROM MV_BDGD_SAP WHERE GRUPO_DE_PLANEJAMENTO='GSE') SAP 
INNER JOIN BDGD_STAGING.TAB_BDGD_SUB_CONN SUB         ON SAP.LOCAL_INSTALACAO=SUB.PAC2
INNER JOIN BDGD_STAGING.TAB_NODE_SUB NS          ON NS.LOC_INST_SAP=SUB.PAC2
LEFT JOIN BDGD_STAGING.MV_GENESIS_EQPTO_SUB GEN ON  'SE-'||GEN.NR_SUB = SAP.SUBESTACAO
LEFT JOIN TARE TARE ON TARE.ARE_LOC=GEN.ARE_LOC
LEFT JOIN TPOTRTV POT ON POT.POT=SAP.A4_TEC
LEFT JOIN BDGD_STAGING.TAB_NODE_SUB NODE2 ON NODE2.LOC_INST_SAP = NS.UN_TR_S
WHERE
SAP.bdgd = 'EQCR'           
)